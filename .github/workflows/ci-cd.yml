name: CI/CD Pipeline - Build on EC2

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'README.md'
  workflow_dispatch:  # Allows manual triggering

jobs:
  build-and-deploy-ec2:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy and Build on EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          PROJECT_PATH: ${{ secrets.EC2_PROJECT_PATH }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸš€ Deploying code to EC2 and building directly on server..."
          
          # Create deployment script
          cat > deploy-build-ec2.sh << 'DEPLOY_SCRIPT'
          #!/bin/bash
          set -e
          
          # Default project path if not set
          if [ -z "$PROJECT_PATH" ]; then
            PROJECT_PATH="/home/$USER/asi-dashboard"
          fi
          
          echo "ðŸ“ Project path: $PROJECT_PATH"
          
          # Navigate to project directory or clone it
          if [ ! -d "$PROJECT_PATH" ]; then
            echo "ðŸ“ Cloning repository..."
            mkdir -p "$(dirname "$PROJECT_PATH")"
            # Use token if provided for private repos
            if [ -n "$GITHUB_TOKEN" ]; then
              GIT_REPO_URL_WITH_AUTH=$(echo "$GIT_REPO_URL" | sed "s|https://|https://${GITHUB_TOKEN}@|")
              git clone "$GIT_REPO_URL_WITH_AUTH" "$PROJECT_PATH"
            else
              git clone "$GIT_REPO_URL" "$PROJECT_PATH"
            fi
            cd "$PROJECT_PATH"
          else
            cd "$PROJECT_PATH"
            echo "â¬‡ï¸ Pulling latest code from repository..."
            # Configure git to use token if provided
            if [ -n "$GITHUB_TOKEN" ]; then
              git config credential.helper store
              echo "https://${GITHUB_TOKEN}@github.com" > ~/.git-credentials
            fi
            git fetch origin
            git reset --hard origin/main 2>/dev/null || git reset --hard origin/master
            git clean -fd
          fi
          
          echo "ðŸ—‘ï¸ Removing old Docker images..."
          docker rmi asi-backend:latest 2>/dev/null || true
          docker rmi asi-frontend:latest 2>/dev/null || true
          docker image prune -af --filter "until=24h" || true
          
          echo "ðŸ”¨ Building backend Docker image on EC2..."
          cd backend
          docker build --no-cache -t asi-backend:latest .
          if [ $? -ne 0 ]; then
            echo "âŒ Backend build failed!"
            exit 1
          fi
          cd ..
          
          echo "ðŸ”¨ Building frontend Docker image on EC2..."
          cd frontend
          docker build --no-cache -t asi-frontend:latest .
          if [ $? -ne 0 ]; then
            echo "âŒ Frontend build failed!"
            exit 1
          fi
          cd ..
          
          echo "ðŸ”„ Restarting containers..."
          
          # Check if using docker-compose
          if [ -f "docker-compose.yml" ]; then
            echo "Using docker-compose..."
            # Update docker-compose.yml to use the images we just built
            docker-compose down
            # Use the images we built (not from registry)
            docker-compose up -d
          # Check if containers are running directly
          elif docker ps -a | grep -q "asi-backend"; then
            echo "Restarting Docker containers..."
            docker stop asi-backend asi-frontend 2>/dev/null || true
            docker rm asi-backend asi-frontend 2>/dev/null || true
            
            # Start backend container
            docker run -d --name asi-backend --restart unless-stopped \
              -p 3000:3000 \
              --env-file backend/.env \
              asi-backend:latest
            
            # Start frontend container
            docker run -d --name asi-frontend --restart unless-stopped \
              -p 8080:8080 \
              -e BACKEND_URL=http://localhost:3000 \
              asi-frontend:latest
          else
            echo "âš ï¸ No deployment method detected."
            echo "Please ensure docker-compose.yml exists or containers are configured."
            exit 1
          fi
          
          echo "âœ… Build and deployment complete!"
          echo "ðŸ“Š Container status:"
          docker ps --filter "name=asi-" || true
          DEPLOY_SCRIPT
          
          # Get repository URL (use HTTPS for cloning)
          GIT_REPO_URL="https://github.com/${GITHUB_REPOSITORY}.git"
          
          # Copy deployment script to EC2
          scp deploy-build-ec2.sh ${EC2_USER}@${EC2_HOST}:/tmp/deploy-build-ec2.sh
          
          # Execute deployment script on EC2
          # Pass GITHUB_TOKEN if repository is private
          ssh ${EC2_USER}@${EC2_HOST} "chmod +x /tmp/deploy-build-ec2.sh && \
            PROJECT_PATH='${PROJECT_PATH}' \
            GIT_REPO_URL='${GIT_REPO_URL}' \
            GITHUB_TOKEN='${GITHUB_TOKEN}' \
            /tmp/deploy-build-ec2.sh"
          
          echo "âœ… Successfully built and deployed on EC2!"

      - name: Deployment Summary
        run: |
          echo "## âœ… Build and Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Built directly on EC2" >> $GITHUB_STEP_SUMMARY
          echo "- **Host**: \`${{ secrets.EC2_HOST }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend Image**: \`asi-backend:latest\` (built on EC2)" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend Image**: \`asi-frontend:latest\` (built on EC2)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ Your application has been built and deployed on EC2!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note**: Images are built directly on EC2, not in GitHub Container Registry." >> $GITHUB_STEP_SUMMARY
